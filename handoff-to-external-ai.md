# 宿曜計算修正依頼パッケージ

## 背景

日本の占術アプリを開発中ですが、宿曜（27宿）の計算が不正確です。
日干と中心星は正確に動作していますが、宿曜だけが検証データと一致しません。

---

## 検証データ（全7件）

以下の日付で、正しい宿曜が算出されるようにしてください。

| 日付 | 日干 | 中心星 | 宿曜（正解） | 現在の出力 |
|------|------|--------|--------------|------------|
| 1979.11.22 | 癸 | 石門星 | **箕宿** | 房宿 ✗ |
| 1982.11.6 | 癸 | 牽牛星 | **柳宿** | 未確認 |
| 1983.6.4 | 癸 | 司禄星 | **壁宿** | 未確認 |
| 1983.6.29 | 戊 | 玉堂星 | **危宿** | 未確認 |
| 1986.9.3 | 庚 | 貫索星 | **翼宿** | 未確認 |
| 1989.10.24 | 丁 | 調舒星 | **軫宿** | 壁宿 ✗ |
| 2000.1.1 | 戊 | 司禄星 | **心宿** | 未確認 |

---

## 現在の実装コード

```typescript
// 27宿の配列（牛宿を除く27宿）
const mansions = ["昴宿","畢宿","觜宿","参宿","井宿","鬼宿","柳宿","星宿","張宿","翼宿","軫宿","角宿","亢宿","氐宿","房宿","心宿","尾宿","箕宿","斗宿","女宿","虚宿","危宿","室宿","壁宿","奎宿","婁宿","胃宿"]

// ユリウス通日計算
function getJulianDayNumber(y: number, m: number, d: number): number {
  if (m <= 2) { y -= 1; m += 12; }
  const A = Math.floor(y / 100)
  const B = 2 - A + Math.floor(A / 4)
  return Math.floor(365.25 * (y + 4716)) + Math.floor(30.6001 * (m + 1)) + d + B - 1524.5
}

// 現在の宿曜計算（不正確）
function calculateSukuyo(y: number, m: number, d: number): string {
  const baseJD = getJulianDayNumber(2000, 1, 1)
  const targetJD = getJulianDayNumber(y, m, d)
  const daysDiff = targetJD - baseJD
  
  // 2000年1月1日 = 心宿(index 15)を基準
  let sukuyoIndex = (15 + daysDiff) % 27
  if (sukuyoIndex < 0) sukuyoIndex += 27
  
  return mansions[sukuyoIndex]
}
```

---

## 問題点

1. **27日周期の単純計算では不正確** - 宿曜は旧暦に基づくため、太陽暦の日数差だけでは正確な結果が得られません
2. **旧暦変換が必要** - 宿曜は旧暦の月日から `(旧暦月のオフセット + 旧暦日 - 1) % 27` で算出されます
3. **朔望月周期の考慮** - 平均朔望月周期 29.530588853日を使った正確な旧暦変換が必要です

---

## 試行した方法と結果

### 方法1: 単純な27日周期
```typescript
sukuyoIndex = (15 + daysDiff) % 27
```
**結果**: 1979.11.22で房宿（正解は箕宿）

### 方法2: 補正値+3を追加
```typescript
sukuyoIndex = (15 + daysDiff + 3) % 27
```
**結果**: 1979.11.22は正解になったが、1989.10.24で壁宿（正解は軫宿）

### 方法3: 旧暦変換（月ごとのオフセットテーブル使用）
```typescript
const baseNM = 2451550.26 // 2000年1月6日新月
const synodic = 29.530588853
const lunarDay = Math.floor(((jd - baseNM) % synodic + synodic) % synodic) + 1
const lunarMonth = ((totalLunations % 12) + 12) % 12 + 1
const monthBase = [21, 23, 25, 0, 2, 4, 7, 10, 12, 14, 17, 19]
const resIdx = (monthBase[lunarMonth - 1] + lunarDay - 1) % 27
```
**結果**: 旧暦月の算出が不正確で、鬼宿（正解は箕宿）

---

## 修正依頼

以下の要件を満たす `calculateSukuyo` 関数を実装してください。

### 必須要件

1. **検証データ全7件で正確な宿曜が算出される**こと
2. **旧暦変換ロジック**を実装すること
   - 基準新月: 2000年1月6日 18:14 (JST) = JDN 2451550.26
   - 平均朔望月周期: 29.530588853日
3. **月ごとの宿開始オフセット**を正確に設定すること
4. **1900年～2100年の範囲で動作**すること

### 実装ヒント

- 旧暦の「月」と「日」を正確に算出する
- 宿曜の公式: `(月のオフセット + 旧暦日 - 1) % 27`
- 閏月の考慮が必要な場合は、簡易的な方法で対応
- 検証データから逆算して、月オフセットテーブルを最適化

---

## 期待する成果物

以下の形式で、修正済みの `calculateSukuyo` 関数を提供してください。

```typescript
function calculateSukuyo(y: number, m: number, d: number): string {
  const mansions = ["昴宿","畢宿","觜宿","参宿","井宿","鬼宿","柳宿","星宿","張宿","翼宿","軫宿","角宿","亢宿","氐宿","房宿","心宿","尾宿","箕宿","斗宿","女宿","虚宿","危宿","室宿","壁宿","奎宿","婁宿","胃宿"]
  
  // ここに正確な旧暦変換と宿曜計算ロジックを実装
  
  return mansions[sukuyoIndex]
}
```

### 検証方法

```typescript
// 全7件の検証データでテスト
console.log(calculateSukuyo(1979, 11, 22)) // 期待: 箕宿
console.log(calculateSukuyo(1982, 11, 6))  // 期待: 柳宿
console.log(calculateSukuyo(1983, 6, 4))   // 期待: 壁宿
console.log(calculateSukuyo(1983, 6, 29))  // 期待: 危宿
console.log(calculateSukuyo(1986, 9, 3))   // 期待: 翼宿
console.log(calculateSukuyo(1989, 10, 24)) // 期待: 軫宿
console.log(calculateSukuyo(2000, 1, 1))   // 期待: 心宿
```

---

## 補足情報

- **宿曜占星術について**: 密教占星術の一種で、27宿（牛宿を除く）を使用
- **配列のindex**: 昴宿=0, 畢宿=1, ..., 胃宿=26
- **旧暦について**: 太陰太陽暦で、1ヶ月は約29.5日、閏月が約3年に1回挿入される

---

## 参考資料

- ユリウス通日 (JDN): 天文学で使用される連続日数
- 朔望月: 新月から次の新月までの平均周期 29.530588853日
- 二十四節気: 太陽の黄道上の位置で決まる（節入り日の計算に使用）

---

## 質問・確認事項

修正作業を開始する前に、以下を確認してください：

1. 検証データの7件全てで正確な宿曜が算出されることが最優先です
2. 実装が複雑になる場合は、検証データから経験的なマッピングテーブルを作成する方法も許容されます
3. コードは TypeScript で記述し、既存の `getJulianDayNumber` 関数を再利用してください

---

修正が完了したら、検証結果とともに `calculateSukuyo` 関数のコードを提供してください。
